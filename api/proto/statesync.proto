syntax = "proto3";

package aetherflow.statesync;

import "google/protobuf/timestamp.proto";

option go_package = "github.com/aetherflow/api/proto/statesync;statesync";

// StateSyncService 状态同步服务
service StateSyncService {
  // 文档管理
  rpc CreateDocument(CreateDocumentRequest) returns (CreateDocumentResponse);
  rpc GetDocument(GetDocumentRequest) returns (GetDocumentResponse);
  rpc UpdateDocument(UpdateDocumentRequest) returns (UpdateDocumentResponse);
  rpc DeleteDocument(DeleteDocumentRequest) returns (DeleteDocumentResponse);
  rpc ListDocuments(ListDocumentsRequest) returns (ListDocumentsResponse);

  // 操作管理
  rpc ApplyOperation(ApplyOperationRequest) returns (ApplyOperationResponse);
  rpc GetOperationHistory(GetOperationHistoryRequest) returns (GetOperationHistoryResponse);

  // 订阅管理  
  rpc SubscribeDocument(SubscribeDocumentRequest) returns (stream OperationEvent);
  rpc UnsubscribeDocument(UnsubscribeDocumentRequest) returns (UnsubscribeDocumentResponse);

  // 锁管理
  rpc AcquireLock(AcquireLockRequest) returns (AcquireLockResponse);
  rpc ReleaseLock(ReleaseLockRequest) returns (ReleaseLockResponse);
  rpc IsLocked(IsLockedRequest) returns (IsLockedResponse);

  // 统计信息
  rpc GetStats(GetStatsRequest) returns (GetStatsResponse);
}

// ==================== 文档相关消息 ====================

message Document {
  string id = 1;
  string name = 2;
  string type = 3;  // whiteboard, text, canvas, sheet
  string state = 4; // active, archived, deleted
  uint64 version = 5;
  bytes content = 6;
  string created_by = 7;
  google.protobuf.Timestamp created_at = 8;
  google.protobuf.Timestamp updated_at = 9;
  string updated_by = 10;
  repeated string active_users = 11;
  Metadata metadata = 12;
}

message Metadata {
  repeated string tags = 1;
  string description = 2;
  map<string, string> properties = 3;
  Permissions permissions = 4;
}

message Permissions {
  string owner = 1;
  repeated string editors = 2;
  repeated string viewers = 3;
  bool public = 4;
}

message CreateDocumentRequest {
  string name = 1;
  string type = 2;
  string created_by = 3;
  bytes content = 4;
  Metadata metadata = 5;
}

message CreateDocumentResponse {
  Document document = 1;
  string error = 2;
}

message GetDocumentRequest {
  string doc_id = 1;
}

message GetDocumentResponse {
  Document document = 1;
  string error = 2;
}

message UpdateDocumentRequest {
  Document document = 1;
}

message UpdateDocumentResponse {
  bool success = 1;
  string error = 2;
}

message DeleteDocumentRequest {
  string doc_id = 1;
  string user_id = 2;
}

message DeleteDocumentResponse {
  bool success = 1;
  string error = 2;
}

message ListDocumentsRequest {
  string type = 1;
  string state = 2;
  string created_by = 3;
  string user_id = 4;
  int32 offset = 5;
  int32 limit = 6;
}

message ListDocumentsResponse {
  repeated Document documents = 1;
  int32 total = 2;
  string error = 3;
}

// ==================== 操作相关消息 ====================

message Operation {
  string id = 1;
  string doc_id = 2;
  string user_id = 3;
  string session_id = 4;
  string type = 5;  // create, update, delete, move, resize, style, text
  bytes data = 6;
  google.protobuf.Timestamp timestamp = 7;
  uint64 version = 8;
  uint64 prev_version = 9;
  string status = 10; // pending, applied, conflict, rejected, resolved
  string client_id = 11;
  OpMetadata metadata = 12;
}

message OpMetadata {
  string ip = 1;
  string user_agent = 2;
  string platform = 3;
  map<string, string> extra = 4;
}

message ApplyOperationRequest {
  Operation operation = 1;
}

message ApplyOperationResponse {
  bool success = 1;
  Operation applied_operation = 2;
  string error = 3;
}

message GetOperationHistoryRequest {
  string doc_id = 1;
  int32 limit = 2;
}

message GetOperationHistoryResponse {
  repeated Operation operations = 1;
  string error = 2;
}

// ==================== 订阅相关消息 ====================

message SubscribeDocumentRequest {
  string doc_id = 1;
  string user_id = 2;
  string session_id = 3;
}

message UnsubscribeDocumentRequest {
  string subscriber_id = 1;
  string doc_id = 2;
  string user_id = 3;
}

message UnsubscribeDocumentResponse {
  bool success = 1;
  string error = 2;
}

message OperationEvent {
  string id = 1;
  string type = 2;  // operation_applied, document_updated, user_joined, user_left, conflict_detected, conflict_resolved
  string doc_id = 3;
  string user_id = 4;
  Operation operation = 5;
  Document document = 6;
  Conflict conflict = 7;
  google.protobuf.Timestamp timestamp = 8;
  map<string, string> data = 9;
}

// ==================== 冲突相关消息 ====================

message Conflict {
  string id = 1;
  string doc_id = 2;
  repeated Operation ops = 3;
  string resolution = 4;  // lww, manual, merge
  string resolved_by = 5;
  Operation resolved_op = 6;
  google.protobuf.Timestamp resolved_at = 7;
  string description = 8;
}

// ==================== 锁相关消息 ====================

message Lock {
  string id = 1;
  string doc_id = 2;
  string user_id = 3;
  string session_id = 4;
  google.protobuf.Timestamp acquired_at = 5;
  google.protobuf.Timestamp expires_at = 6;
  bool active = 7;
}

message AcquireLockRequest {
  string doc_id = 1;
  string user_id = 2;
  string session_id = 3;
}

message AcquireLockResponse {
  Lock lock = 1;
  string error = 2;
}

message ReleaseLockRequest {
  string doc_id = 1;
  string user_id = 2;
}

message ReleaseLockResponse {
  bool success = 1;
  string error = 2;
}

message IsLockedRequest {
  string doc_id = 1;
}

message IsLockedResponse {
  bool locked = 1;
  Lock lock = 2;
  string error = 3;
}

// ==================== 统计信息相关消息 ====================

message Stats {
  int64 total_documents = 1;
  int64 active_documents = 2;
  int64 archived_documents = 3;
  int64 total_operations = 4;
  int64 total_conflicts = 5;
  int64 resolved_conflicts = 6;
  int64 active_subscribers = 7;
  int64 active_locks = 8;
  google.protobuf.Timestamp last_updated = 9;
}

message GetStatsRequest {
  // 空请求
}

message GetStatsResponse {
  Stats stats = 1;
  string error = 2;
}
